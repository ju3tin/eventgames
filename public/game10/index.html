<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance Game - Dual Pose Detection</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background: #111; 
            color: white; 
            margin: 0; 
            padding: 20px;
        }
        .container {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .video-box {
            position: relative;
            width: 480px;
        }
        video, canvas {
            width: 100%;
            height: auto;
            border: 3px solid #444;
            border-radius: 8px;
            background: black;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        #tutorial-box { border-color: #4CAF50; }
        #user-box { border-color: #2196F3; }
        #score { font-size: 32px; margin: 20px; }
        #current-move { font-size: 28px; color: #FFD700; margin: 10px; }
        button { 
            padding: 15px 30px; 
            font-size: 20px; 
            background: #FF5722; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 20px;
        }
        button:hover { background: #E64A19; }
        h3 { margin: 10px 0; }
    </style>

    <!-- TensorFlow.js & Pose Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
</head>
<body>
    <h1>Dance Mirror Game - Follow the Pose!</h1>
    <p>Copy the green skeleton (tutorial) with your blue skeleton!</p>

    <div class="container">
        <!-- Tutorial video with pose overlay -->
        <div class="video-box" id="tutorial-box">
            <h3>Tutorial (Green = Ideal Pose)</h3>
            <video id="tutorial-video" loop muted playsinline>
                <!-- Replace with a REAL short dance tutorial MP4 -->
                <!-- Example free test video (big buck bunny - replace with dance!) -->
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <canvas id="tutorial-canvas"></canvas>
        </div>

        <!-- User webcam with pose overlay -->
        <div class="video-box" id="user-box">
            <h3>You (Blue = Your Pose)</h3>
            <video id="user-video" autoplay playsinline></video>
            <canvas id="user-canvas"></canvas>
        </div>
    </div>

    <div id="current-move">Current Move: Waiting...</div>
    <div id="score">Score: 0</div>
    <button id="start-button">Start Game</button>

    <script>
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Config & Globals
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let detector;
        let score = 0;
        let gameRunning = false;
        let currentMoveIndex = 0;

        const tutorialVideo = document.getElementById('tutorial-video');
        const tutorialCanvas = document.getElementById('tutorial-canvas');
        const tutorialCtx = tutorialCanvas.getContext('2d');

        const userVideo = document.getElementById('user-video');
        const userCanvas = document.getElementById('user-canvas');
        const userCtx = userCanvas.getContext('2d');

        // Match canvas sizes once videos are ready
        function resizeCanvases() {
            tutorialCanvas.width = tutorialVideo.videoWidth;
            tutorialCanvas.height = tutorialVideo.videoHeight;
            userCanvas.width = userVideo.videoWidth;
            userCanvas.height = userVideo.videoHeight;
        }

        tutorialVideo.onloadedmetadata = resizeCanvases;
        userVideo.onloadedmetadata = resizeCanvases;

        // Dance moves checks (expand as needed)
        const danceMoves = [
            {
                name: "Arms Up âœ‹",
                check: (keypoints) => {
                    const lw = keypoints.find(k => k.name === 'left_wrist');
                    const rw = keypoints.find(k => k.name === 'right_wrist');
                    const ls = keypoints.find(k => k.name === 'left_shoulder');
                    const rs = keypoints.find(k => k.name === 'right_shoulder');
                    return lw?.score > 0.4 && rw?.score > 0.4 &&
                           lw.y < ls.y - 50 && rw.y < rs.y - 50;
                }
            },
            {
                name: "Arms Out ðŸ¤—",
                check: (keypoints) => {
                    const lw = keypoints.find(k => k.name === 'left_wrist');
                    const rw = keypoints.find(k => k.name === 'right_wrist');
                    const ls = keypoints.find(k => k.name === 'left_shoulder');
                    const rs = keypoints.find(k => k.name === 'right_shoulder');
                    return lw?.score > 0.4 && rw?.score > 0.4 &&
                           Math.abs(lw.x - ls.x) > 120 && Math.abs(rw.x - rs.x) > 120;
                }
            },
            {
                name: "Knees Up / Jump ðŸ¦µ",
                check: (keypoints) => {
                    const lk = keypoints.find(k => k.name === 'left_knee');
                    const rk = keypoints.find(k => k.name === 'right_knee');
                    const lh = keypoints.find(k => k.name === 'left_hip');
                    const rh = keypoints.find(k => k.name === 'right_hip');
                    return lk?.score > 0.4 && rk?.score > 0.4 &&
                           lk.y < lh.y - 70 && rk.y < rh.y - 70;
                }
            }
        ];

        async function init() {
            // Load MoveNet (Lightning = faster)
            const model = poseDetection.SupportedModels.MoveNet;
            detector = await poseDetection.createDetector(model, {
                modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
            });

            // Webcam
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                userVideo.srcObject = stream;
            } catch (err) {
                alert("Webcam access denied. Game can't start without it.");
                return;
            }

            document.getElementById('start-button').addEventListener('click', startGame);
        }

        function startGame() {
            if (gameRunning) return;
            gameRunning = true;
            score = 0;
            currentMoveIndex = 0;
            updateUI();

            tutorialVideo.currentTime = 0;
            tutorialVideo.play().catch(e => console.log("Video play failed:", e));

            detectLoop();
            nextMove();
        }

        function nextMove() {
            if (currentMoveIndex >= danceMoves.length) {
                endGame();
                return;
            }
            document.getElementById('current-move').textContent = 
                `Do this: ${danceMoves[currentMoveIndex].name}`;
        }

        async function detectLoop() {
            if (!gameRunning) return;

            // Detect on tutorial video
            if (tutorialVideo.readyState >= 2) {  // HAVE_CURRENT_DATA
                const tutorialPoses = await detector.estimatePoses(tutorialVideo);
                drawPose(tutorialCtx, tutorialPoses, 'lime'); // Green for tutorial
            }

            // Detect on user
            if (userVideo.readyState >= 2) {
                const userPoses = await detector.estimatePoses(userVideo);
                drawPose(userCtx, userPoses, 'cyan'); // Cyan for user

                if (userPoses.length > 0 && currentMoveIndex < danceMoves.length) {
                    const move = danceMoves[currentMoveIndex];
                    if (move.check(userPoses[0].keypoints)) {
                        score += 25;
                        updateUI();
                        currentMoveIndex++;
                        nextMove();
                    }
                }
            }

            requestAnimationFrame(detectLoop);
        }

        function drawPose(ctx, poses, color) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            if (poses.length > 0) {
                const keypoints = poses[0].keypoints;
                const pairs = poseDetection.util.getAdjacentPairs(poseDetection.SupportedModels.MoveNet);

                // Keypoints
                keypoints.forEach(kp => {
                    if (kp.score > 0.35) {
                        ctx.beginPath();
                        ctx.arc(kp.x, kp.y, 7, 0, 2 * Math.PI);
                        ctx.fillStyle = color;
                        ctx.fill();
                    }
                });

                // Skeleton lines
                pairs.forEach(([i, j]) => {
                    const a = keypoints[i];
                    const b = keypoints[j];
                    if (a.score > 0.35 && b.score > 0.35) {
                        ctx.beginPath();
                        ctx.moveTo(a.x, a.y);
                        ctx.lineTo(b.x, b.y);
                        ctx.lineWidth = 5;
                        ctx.strokeStyle = color;
                        ctx.stroke();
                    }
                });
            }
        }

        function updateUI() {
            document.getElementById('score').textContent = `Score: ${score}`;
        }

        function endGame() {
            gameRunning = false;
            tutorialVideo.pause();
            alert(`Game Over! Final Score: ${score}\nYou followed the poses great!`);
            document.getElementById('current-move').textContent = 'Game Finished!';
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>